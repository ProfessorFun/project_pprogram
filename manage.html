<!DOCTYPE html>
<html>

<head>
  <title>test</title>
  <meta charset="utf-8">
  <link href="manage.css" rel="stylesheet" type="text/css" />
</head>

<style>
  .tab tr:nth-child(odd) {
    background: rgb(238, 238, 238)
  }

  .tab tr:nth-child(even) {
    background: #FFF
  }

  .tab tr:hover {
    background-color: rgb(211, 211, 211);
  }
</style>

<body>
  <h1 align="center">後臺管理系統</h1><br>

  <form align="center">
    First name:
    <input type="text" id="search_target">
    <input type="button" value="搜尋" onclick="search_text(this)">
    <input type="button" value="回首頁" onclick="reload()">
  </form><br>

  <table class="tab" id="tab" border="1" align="center">

    <tr class="ro">
      <th width=30%>
        標題
      </th>

      <th width=10% class="source_filter">
        來源
      </th>

      <th width=15%>
        類別
      </th>

      <th width=15%>
        TAG
      </th>

      <th width=6% class="display_filter">
        顯示
      </th>

      <th width=8% colspan="2">

      </th>


    </tr>

  </table>

  <table>
    <tr class="page_button">
      <p align="center">
        <button onclick="before_clear_table()" id="leftButton">before</button>
        <button onclick="next_clear_table()" id="rightButton">next</button>
      </p>
    </tr>
  </table>

  <script src="jquery-3.4.1.js"></script>
  <script>
    var table_color_swich = 1;
    var page = 1;
    var all_page;
    $(function () {/*API操作和顯示區*/
      var final_hash;
      var user_name;
      var local_hash;
      var url = window.location.search;
      var hash = url.substr(1);
      if (hash != "") {
        if (hash.substr(0, 10) < 0) {
          localStorage.user = hash;
          local_hash = localStorage.user;
          final_hash = local_hash.substr(0, 20);
          user_name = local_hash.substr(20);
        } else {
          localStorage.user = hash;
          local_hash = localStorage.user;
          final_hash = local_hash.substr(0, 19);
          user_name = local_hash.substr(19);
        }
      }
      else {
        local_hash = localStorage.user;
        if (local_hash.substr(0, 10) < 0) {
          final_hash = local_hash.substr(0, 20);
          user_name = local_hash.substr(20);
        } else {
          final_hash = local_hash.substr(0, 19);
          user_name = local_hash.substr(19);
        }
      }

      $.ajax({
        type: 'get',
        url: ' https://djangotest1156.herokuapp.com/api/RSS/get_info_for_page/',
        data: {
          "page": "1",
        },
        success: function (result) {
          console.log(result);
          $.each(result[0], function (index, element) {
            append_table(element);
          });
        },
        error: function () {
          alert("錯誤")
        }

      });
    });

    function append_table(data) {
      $('.tab').append(
        $('<tr>').append(

          $('<td class="title">').append(
            $('<p>',
              { text: data[1] })
          ),


          $('<td class="source">').append(
            $('<p>',
              { text: data[2] })
          ),

          $('<td class="category">').append(
            $('<p>',
              { text: data[3] })
          ),

          $('<td class="tag">').append(
            $('<p>',
              { text: data[4] })
          ),

          $('<td class="display">').append(
            $('<p>',
              { text: data[5] })
          ),

          $('<td colspan="2" class="edit">').append(
            $('<input type="button" onclick="Edit_Id(this)" value="編輯"  style="margin:5px;width:50px;height:50px;">'),
            $('<p>', { text: data[0] }),
            $('<input type="button" onclick="Delete_Id(this)" value="刪除" style="margin:5px;width:50px;height:50px;">'),
            $('<p>', { text: data[0] })
          )
        )

      )
      $("td.edit").children("p").css("display", "none");
    }

    function call_data(num) {
      $.ajax({
        type: 'get',
        url: ' https://djangotest1156.herokuapp.com/api/RSS/get_info_for_page/',
        data: {
          "page": num,
        },
        success: function (result) {
          console.log(result);
          $.each(result[0], function (index, element) {
            all_page = Math.floor(result[1] / 20);
            append_table(element);
          });
        },
        error: function () {
          alert("錯誤")
        }

      });

    }

    function clear_table() {
      $("#tab tr:not(:first)").html("");
    }

    function reload(){
      window.location.reload();
    }

    function next_clear_table() {
      if (page != all_page + 1) {
        var ntpage;
        ntpage = page + 1;
        page = ntpage;
        $("#tab tr:not(:first)").html("");
        call_data(ntpage);
      }
    }

    function before_clear_table() {
      if (page != 1) {
        var bfpage;
        bfpage = page - 1;
        page = bfpage;
        $("#tab tr:not(:first)").html("");
        call_data(bfpage);
      }
    }

    function search_text(e) {
      let se_ta = document.getElementById("search_target");
      console.log(se_ta);
      var target = se_ta.value;
      console.log(target);
      search(target);
    }

    function Edit_Id(e) {
      let EdId = e.nextSibling;
      var EID = EdId.innerHTML;
      console.log(EID);
      window.location.href = "modify.html" + "?" + "id=" + EID;
    }

    function Delete_Id(e) {
      let DeId = e.nextSibling;
      var DID = DeId.innerHTML;
      Delete_Data(DID);
    }

    function Delete_Data(DID) {
      console.log(DID);
      console.log('asd');
      $(function () {
        console.log(DID);
        $.ajax({
          type: 'delete',
          url: 'https://djangotest1156.herokuapp.com/api/RSS/delete/',
          dataType: 'json',
          data: {
            'id': DID
          },
          success: function (result) {
            console.log(result);
            alert(result);
            window.location.reload()
          },
          error: function (xhr) {
            alert(xhr)
          }

        });

      })
    }

    function search(target) {
      $(function () {
        $.ajax({
          type: 'get',
          url: 'https://djangotest1156.herokuapp.com/api/RSS/search_data/',
          dataType: 'json',
          data: {
            'title': target
          },

          success: function (result) {
            console.log(result);
            clear_table();
            $.each(result[0], function (index, element) {
              append_table(element);
            }),
            $("button").css("display", "none");
          },
          error: function (xhr) {
            alert(xhr)
          }

        });

      })

    }


  </script>

</body>

</html>